<!DOCTYPE html>
<html lang="tr" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Premium Plus</title>
    <meta name="description" content="YouTube Data API ile güçlendirilmiş modern premium izleme deneyimi">
    <meta name="theme-color" content="#ff0000">
    <style>
        :root {
            --primary: #ff0000;
            --secondary: #181818;
            --bg-primary: #ffffff;
            --bg-secondary: rgba(255,255,255,0.7);
            --bg-elevated: rgba(255,255,255,0.9);
            --text-primary: #111111;
            --text-secondary: #606060;
            --border: rgba(0,0,0,0.08);
            --glass: rgba(255,255,255,0.2);
            --shadow: 0 20px 40px rgba(0,0,0,0.1);
            color-scheme: light;
        }

        [data-theme="dark"] {
            --bg-primary: #0f0f0f;
            --bg-secondary: rgba(18,18,18,0.7);
            --bg-elevated: rgba(24,24,24,0.85);
            --text-primary: #f1f1f1;
            --text-secondary: #9a9a9a;
            --border: rgba(255,255,255,0.08);
            --glass: rgba(0,0,0,0.35);
            --shadow: 0 20px 40px rgba(0,0,0,0.5);
            color-scheme: dark;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            transition: background 0.4s ease, color 0.3s ease;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, rgba(255,0,0,0.8), rgba(255,0,0,0.4));
            border-radius: 999px;
        }

        header {
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(20px);
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        .header-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px clamp(16px, 4vw, 36px);
            gap: 12px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            color: var(--text-primary);
            text-decoration: none;
            font-size: clamp(20px, 3vw, 26px);
        }

        .brand::before {
            content: "▶";
            display: inline-flex;
            width: 36px;
            height: 36px;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(255,0,0,0.9), rgba(255,85,0,0.7));
            color: white;
            font-size: 18px;
        }

        .search-group {
            flex: 1;
            position: relative;
            max-width: 640px;
            display: flex;
            align-items: center;
        }

        .history-dropdown {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            box-shadow: var(--shadow);
            z-index: 50;
        }

        .search-group input {
            width: 100%;
            padding: 12px 48px 12px 18px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: inherit;
            font-size: 16px;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
            transition: border 0.3s ease, box-shadow 0.3s ease;
        }

        .search-group input:focus {
            outline: none;
            border: 1px solid rgba(255,0,0,0.5);
            box-shadow: 0 0 0 4px rgba(255,0,0,0.15);
        }

        .search-group button {
            position: absolute;
            right: 6px;
            background: var(--primary);
            color: white;
            border: none;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            cursor: pointer;
            display: grid;
            place-items: center;
            transition: transform 0.2s ease;
        }

        .search-group button:hover { transform: translateY(-1px) scale(1.02); }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chip {
            border-radius: 999px;
            border: 1px solid transparent;
            padding: 8px 14px;
            font-size: 14px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.2s ease, border 0.2s ease, background 0.2s ease;
        }

        .chip:hover {
            transform: translateY(-1px);
            border-color: rgba(255,255,255,0.25);
            background: rgba(255,0,0,0.1);
        }

        .chip.active {
            background: linear-gradient(135deg, rgba(255,0,0,0.9), rgba(255,85,0,0.8));
            color: white;
            border: none;
        }

        nav {
            padding: 12px clamp(16px, 4vw, 36px);
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            backdrop-filter: blur(12px);
        }

        .category-row {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .category-row::-webkit-scrollbar { display: none; }

        main {
            flex: 1;
            width: min(1280px, 94vw);
            margin: 24px auto 120px;
            display: grid;
            gap: 42px;
        }

        section {
            display: grid;
            gap: 24px;
        }

        h2.section-title {
            font-size: clamp(20px, 3vw, 26px);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        h2.section-title::before {
            content: "";
            width: 6px;
            height: 28px;
            border-radius: 999px;
            background: linear-gradient(180deg, rgba(255,0,0,0.9), rgba(255,85,0,0.7));
        }

        .video-grid {
            display: grid;
            gap: clamp(16px, 3vw, 26px);
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        }

        .video-card {
            border-radius: 22px;
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(14px);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            position: relative;
            min-height: 340px;
        }

        .video-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 24px 45px rgba(0,0,0,0.25);
        }

        .thumb {
            position: relative;
            aspect-ratio: 16 / 9;
            overflow: hidden;
        }

        .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s ease;
        }

        .video-card:hover .thumb img { transform: scale(1.07); }

        .thumb .duration {
            position: absolute;
            bottom: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .thumb .preview {
            position: absolute;
            inset: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .video-card:hover .thumb .preview { opacity: 1; }

        .video-body {
            padding: 18px;
            display: grid;
            gap: 12px;
        }

        .video-title {
            font-size: 16px;
            font-weight: 600;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .video-meta {
            display: flex;
            flex-direction: column;
            gap: 6px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .meta-row { display: flex; gap: 8px; align-items: center; }

        .card-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            border: none;
            background: rgba(255,255,255,0.14);
            color: inherit;
            display: grid;
            place-items: center;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.2s ease;
        }

        .icon-btn:hover { transform: translateY(-1px); background: rgba(255,0,0,0.2); }

        .tag {
            border-radius: 6px;
            padding: 2px 6px;
            background: rgba(255,0,0,0.1);
            color: var(--primary);
            font-weight: 600;
            font-size: 12px;
        }

        .loader, .error-state {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 42px;
            gap: 16px;
        }

        .spinner {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(16px);
            display: none;
            align-items: center;
            justify-content: center;
            padding: clamp(12px, 4vw, 32px);
            z-index: 3000;
        }

        .modal.open { display: flex; }

        .modal-card {
            width: min(1080px, 100%);
            background: var(--bg-primary);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: var(--shadow);
            display: grid;
            grid-template-rows: auto auto 1fr;
        }

        .modal-header {
            padding: 18px clamp(18px, 4vw, 32px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            border-bottom: 1px solid var(--border);
        }

        .modal-player {
            aspect-ratio: 16 / 9;
            background: #000;
        }

        .modal-body {
            padding: 20px clamp(18px, 4vw, 32px);
            display: grid;
            gap: 14px;
            max-height: 320px;
            overflow-y: auto;
        }

        .detail-grid {
            display: grid;
            gap: 18px;
        }

        .channel-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .channel-info img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
        }

        .player-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .select, select {
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 10px 14px;
            color: inherit;
        }

        .mini-player {
            position: fixed;
            width: 320px;
            aspect-ratio: 16/9;
            bottom: 24px;
            right: 24px;
            background: #000;
            border-radius: 18px;
            overflow: hidden;
            box-shadow: var(--shadow);
            display: none;
            flex-direction: column;
            z-index: 2500;
        }

        .mini-player.open { display: flex; }

        .mini-bar {
            padding: 10px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            background: rgba(0,0,0,0.6);
            color: white;
            cursor: move;
        }

        .queue-panel, .settings-drawer {
            position: fixed;
            top: 0;
            bottom: 0;
            right: -420px;
            width: min(380px, 90vw);
            background: var(--bg-primary);
            box-shadow: -8px 0 30px rgba(0,0,0,0.25);
            transition: transform 0.35s ease;
            transform: translateX(0);
            display: flex;
            flex-direction: column;
            z-index: 2200;
            border-left: 1px solid var(--border);
            backdrop-filter: blur(20px);
        }

        .queue-panel.open, .settings-drawer.open { right: 0; }

        .drawer-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .drawer-body {
            padding: 18px;
            overflow-y: auto;
            display: grid;
            gap: 18px;
            flex: 1;
        }

        .queue-item {
            display: grid;
            grid-template-columns: 90px 1fr auto;
            gap: 12px;
            padding: 12px;
            border-radius: 16px;
            background: var(--bg-secondary);
            cursor: pointer;
            align-items: center;
            transition: transform 0.2s ease;
        }

        .queue-item:hover { transform: translateY(-2px); }

        .queue-item.active { outline: 2px solid var(--primary); }

        .pill-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-secondary);
            padding: 10px 14px;
            border-radius: 14px;
        }

        .switch {
            position: relative;
            width: 46px;
            height: 24px;
        }

        .switch input { opacity: 0; width: 0; height: 0; }

        .slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 999px;
            transition: 0.3s;
        }

        .slider::before {
            content: "";
            position: absolute;
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background: linear-gradient(135deg, rgba(255,0,0,0.9), rgba(255,80,0,0.9));
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(120%);
            padding: 16px 26px;
            border-radius: 18px;
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: transform 0.4s cubic-bezier(.4,.04,.2,1);
            z-index: 4000;
        }

        .toast.show { transform: translateX(-50%) translateY(-16px); }

        .badge {
            border-radius: 999px;
            padding: 3px 10px;
            background: rgba(255,0,0,0.15);
            color: var(--primary);
            font-weight: 600;
            font-size: 12px;
        }

        .settings-group {
            display: grid;
            gap: 12px;
            background: var(--bg-secondary);
            padding: 14px;
            border-radius: 16px;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 12px;
            color: inherit;
        }

        .sentinel { height: 2px; }

        .focus-mode header,
        .focus-mode nav,
        .focus-mode .category-row,
        .focus-mode .header-actions,
        .focus-mode .search-group { opacity: 0; pointer-events: none; }

        .focus-mode .modal-card { width: min(1400px, 100%); }

        @media (max-width: 900px) {
            .header-inner { flex-wrap: wrap; }
            .mini-player { width: 240px; }
            .video-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
        }

        @media (max-width: 600px) {
            nav { position: sticky; top: 70px; z-index: 900; }
            .video-card { min-height: auto; }
            .modal-card { border-radius: 16px; }
            main { margin-bottom: 160px; }
            .mini-player { bottom: 90px; right: 16px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-inner">
            <a href="#" class="brand" id="homeLink">YT Premium+</a>
            <div class="search-group">
                <input id="searchInput" type="search" placeholder="Videolar, kanallar, podcastler..." aria-label="Arama">
                <button id="searchBtn" aria-label="Ara">🔍</button>
                <div id="searchHistory" class="history-dropdown" hidden></div>
            </div>
            <div class="header-actions">
                <button class="chip" id="themeToggle">🌗 Tema</button>
                <button class="chip" id="focusToggle">🎬 Focus</button>
                <button class="chip" id="queueToggle">📼 Kuyruk</button>
                <button class="chip" id="settingsToggle">⚙️ Ayarlar</button>
            </div>
        </div>
    </header>

    <nav>
        <div class="category-row" id="categoryRow"></div>
    </nav>

    <main>
        <section id="trendingSection">
            <h2 class="section-title">🔥 Trend Videolar</h2>
            <div id="trendingGrid" class="video-grid"></div>
        </section>

        <section id="searchSection" hidden>
            <h2 class="section-title" id="searchTitle">🔍 Arama Sonuçları</h2>
            <div id="searchGrid" class="video-grid"></div>
        </section>

        <section id="favoritesSection">
            <h2 class="section-title">❤️ Favoriler & İzleme Listeleri</h2>
            <div class="video-grid" id="favoritesGrid"></div>
        </section>

        <section id="watchLaterSection">
            <h2 class="section-title">🕒 Daha Sonra İzle</h2>
            <div class="video-grid" id="watchLaterGrid"></div>
        </section>

        <section id="historySection">
            <h2 class="section-title">🧭 İzleme Geçmişi</h2>
            <div class="video-grid" id="historyGrid"></div>
        </section>

        <div class="loader" id="globalLoader" hidden>
            <div class="spinner"></div>
            <span>Veriler yükleniyor...</span>
        </div>
        <div class="error-state" id="errorState" hidden>
            <span>⚠️</span>
            <div>
                <p id="errorMessage">Bir şeyler ters gitti.</p>
                <button class="chip" id="retryBtn">Tekrar Dene</button>
            </div>
        </div>
        <div class="sentinel" id="sentinel"></div>
    </main>

    <div class="modal" id="videoModal" role="dialog" aria-modal="true">
        <div class="modal-card">
            <div class="modal-header">
                <h3 id="modalTitle">Video</h3>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button class="chip" id="downloadBtn">⬇️ İndir</button>
                    <button class="chip" id="loopBtn">🔁 Loop: Kapalı</button>
                    <button class="chip" id="closeModal">✖</button>
                </div>
            </div>
            <div class="modal-player" id="modalPlayer"></div>
            <div class="modal-body">
                <div class="detail-grid">
                    <div class="channel-info" id="channelInfo"></div>
                    <div class="video-stats" id="videoStats"></div>
                    <div class="video-description" id="videoDescription"></div>
                </div>
                <div class="player-controls">
                    <label>Oynatma Hızı
                        <select id="speedControl">
                            <option value="0.25">0.25x</option>
                            <option value="0.5">0.5x</option>
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>1x</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="1.75">1.75x</option>
                            <option value="2">2x</option>
                        </select>
                    </label>
                    <label>Kalite
                        <select id="qualityControl">
                            <option value="auto">Otomatik</option>
                            <option value="hd1080">1080p</option>
                            <option value="hd720">720p</option>
                            <option value="large">480p</option>
                            <option value="medium">360p</option>
                            <option value="small">240p</option>
                        </select>
                    </label>
                    <label>Uyku Zamanlayıcı
                        <select id="sleepTimer">
                            <option value="0">Kapalı</option>
                            <option value="5">5 dk</option>
                            <option value="10">10 dk</option>
                            <option value="20">20 dk</option>
                            <option value="30">30 dk</option>
                        </select>
                    </label>
                    <label>Playlist'e Ekle
                        <select id="playlistSelect"></select>
                    </label>
                </div>
                <div style="display:flex; gap:12px; flex-wrap:wrap;">
                    <button class="chip" id="watchLaterBtn">🕒 Daha Sonra</button>
                    <button class="chip" id="favoriteBtn">❤️ Favori</button>
                    <button class="chip" id="queueAddBtn">➕ Kuyruğa Ekle</button>
                    <button class="chip" id="miniBtn">📺 Mini Player</button>
                    <button class="chip" id="castBtn">📡 Cast</button>
                    <button class="chip" id="focusBtn">🧘 Focus</button>
                </div>
            </div>
        </div>
    </div>

    <div class="mini-player" id="miniPlayer">
        <div class="mini-bar" id="miniBar">
            <span id="miniTitle">Mini Player</span>
            <div style="display:flex; gap:6px;">
                <button class="icon-btn" id="miniPlayPause">⏯</button>
                <button class="icon-btn" id="miniClose">✖</button>
            </div>
        </div>
        <div id="miniPlayerFrame" style="flex:1; background:#000;"></div>
    </div>

    <aside class="queue-panel" id="queuePanel" aria-label="Video kuyruğu">
        <div class="drawer-header">
            <h3>Oynatma Kuyruğu</h3>
            <button class="chip" id="queueClear">Temizle</button>
        </div>
        <div class="drawer-body" id="queueList"></div>
    </aside>

    <aside class="settings-drawer" id="settingsDrawer" aria-label="Ayarlar">
        <div class="drawer-header">
            <h3>Premium Ayarlar</h3>
            <button class="chip" id="settingsClose">Kapat</button>
        </div>
        <div class="drawer-body">
            <div class="settings-group">
                <div class="pill-toggle">
                    <span>🎯 Otomatik Oynatma</span>
                    <label class="switch">
                        <input type="checkbox" id="autoPlayToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="pill-toggle">
                    <span>🛡️ Reklam Engelleyici</span>
                    <label class="switch">
                        <input type="checkbox" id="adBlockToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="pill-toggle">
                    <span>📶 Bandwidth Saver</span>
                    <label class="switch">
                        <input type="checkbox" id="bandwidthToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="pill-toggle">
                    <span>📥 Çevrimdışı Önbellek</span>
                    <label class="switch">
                        <input type="checkbox" id="offlineToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="settings-group">
                <h4>Özel Playlistler</h4>
                <div style="display:flex; gap:8px;">
                    <input id="playlistName" placeholder="Yeni playlist adı" style="flex:1; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:var(--bg-secondary); color:inherit;">
                    <button class="chip" id="createPlaylist">Oluştur</button>
                </div>
                <div id="playlistList" style="display:grid; gap:8px;"></div>
            </div>

            <div class="settings-group">
                <h4>Bildirimler</h4>
                <p>Yeni trend videolarda bildirim almak için izni verin.</p>
                <button class="chip" id="notifyBtn">🔔 Bildirim İzni</button>
            </div>

            <div class="settings-group">
                <h4>Veri Yönetimi</h4>
                <button class="chip" id="exportBtn">📤 Ayarları Dışa Aktar</button>
                <input type="file" id="importInput" accept="application/json" hidden>
                <button class="chip" id="importBtn">📥 İçeri Aktar</button>
                <button class="chip" id="clearHistory">🗑 Geçmişi Temizle</button>
            </div>
        </div>
    </aside>

    <div class="toast" id="toast" role="status"></div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <script>
        const API_KEY = 'AIzaSyCC0F6nmwpMoxt4bghLAaxUwo2V4QwxuLI';
        const API_BASE = 'https://www.googleapis.com/youtube/v3';
        const CATEGORIES = [
            { id: '', title: 'Tümü' },
            { id: '10', title: 'Müzik' },
            { id: '17', title: 'Spor' },
            { id: '20', title: 'Oyun' },
            { id: '24', title: 'Eğlence' },
            { id: '28', title: 'Bilim & Teknoloji' },
            { id: '1', title: 'Film & Animasyon' },
            { id: '25', title: 'Haber' },
            { id: '26', title: 'Nasıl Yapılır' },
            { id: '27', title: 'Eğitim' },
            { id: '22', title: 'İnsanlar & Bloglar' },
            { id: '15', title: 'Evcil Hayvanlar' },
            { id: '2', title: 'Arabalar' },
            { id: 'podcast', title: 'Podcast' }
        ];

        const appState = {
            theme: localStorage.getItem('yt-theme') || 'light',
            searchQuery: '',
            nextPageToken: null,
            activeCategory: '',
            currentVideo: null,
            queue: JSON.parse(localStorage.getItem('yt-queue') || '[]'),
            favorites: JSON.parse(localStorage.getItem('yt-favorites') || '[]'),
            watchLater: JSON.parse(localStorage.getItem('yt-watchlater') || '[]'),
            history: JSON.parse(localStorage.getItem('yt-history') || '[]'),
            playlists: JSON.parse(localStorage.getItem('yt-playlists') || '{}'),
            searchHistory: JSON.parse(localStorage.getItem('yt-search-history') || '[]'),
            loopMode: localStorage.getItem('yt-loop') || 'off',
            autoPlay: localStorage.getItem('yt-autoplay') !== 'false',
            adBlockEnabled: localStorage.getItem('yt-adblock') !== 'false',
            bandwidthSaver: localStorage.getItem('yt-bandwidth') === 'true',
            offlineEnabled: localStorage.getItem('yt-offline') === 'true',
            playbackSpeed: parseFloat(localStorage.getItem('yt-speed') || '1'),
            quality: localStorage.getItem('yt-quality') || 'auto',
            sleepTimeout: null,
            isLoading: false,
            trendingSignature: localStorage.getItem('yt-trending-signature') || '',
            sentinelObserver: null,
            abortController: null
        };

        let ytModalPlayer = null;
        let ytMiniPlayer = null;
        let castContext = null;
        let dbPromise = null;
        let audioContext;

        const elements = {
            searchInput: document.getElementById('searchInput'),
            searchBtn: document.getElementById('searchBtn'),
            searchTitle: document.getElementById('searchTitle'),
            trendingGrid: document.getElementById('trendingGrid'),
            searchGrid: document.getElementById('searchGrid'),
            favoritesGrid: document.getElementById('favoritesGrid'),
            watchLaterGrid: document.getElementById('watchLaterGrid'),
            historyGrid: document.getElementById('historyGrid'),
            loader: document.getElementById('globalLoader'),
            error: document.getElementById('errorState'),
            errorMessage: document.getElementById('errorMessage'),
            retryBtn: document.getElementById('retryBtn'),
            toast: document.getElementById('toast'),
            sentinel: document.getElementById('sentinel'),
            themeToggle: document.getElementById('themeToggle'),
            focusToggle: document.getElementById('focusToggle'),
            queueToggle: document.getElementById('queueToggle'),
            settingsToggle: document.getElementById('settingsToggle'),
            queuePanel: document.getElementById('queuePanel'),
            queueList: document.getElementById('queueList'),
            queueClear: document.getElementById('queueClear'),
            settingsDrawer: document.getElementById('settingsDrawer'),
            settingsClose: document.getElementById('settingsClose'),
            autoPlayToggle: document.getElementById('autoPlayToggle'),
            adBlockToggle: document.getElementById('adBlockToggle'),
            bandwidthToggle: document.getElementById('bandwidthToggle'),
            offlineToggle: document.getElementById('offlineToggle'),
            notifyBtn: document.getElementById('notifyBtn'),
            exportBtn: document.getElementById('exportBtn'),
            importBtn: document.getElementById('importBtn'),
            importInput: document.getElementById('importInput'),
            clearHistory: document.getElementById('clearHistory'),
            playlistName: document.getElementById('playlistName'),
            playlistList: document.getElementById('playlistList'),
            createPlaylist: document.getElementById('createPlaylist'),
            categoryRow: document.getElementById('categoryRow'),
            searchSection: document.getElementById('searchSection'),
            trendingSection: document.getElementById('trendingSection'),
            homeLink: document.getElementById('homeLink'),
            searchHistory: document.getElementById('searchHistory'),
            videoModal: document.getElementById('videoModal'),
            modalTitle: document.getElementById('modalTitle'),
            closeModal: document.getElementById('closeModal'),
            loopBtn: document.getElementById('loopBtn'),
            downloadBtn: document.getElementById('downloadBtn'),
            modalPlayer: document.getElementById('modalPlayer'),
            videoDescription: document.getElementById('videoDescription'),
            videoStats: document.getElementById('videoStats'),
            channelInfo: document.getElementById('channelInfo'),
            speedControl: document.getElementById('speedControl'),
            qualityControl: document.getElementById('qualityControl'),
            sleepTimer: document.getElementById('sleepTimer'),
            playlistSelect: document.getElementById('playlistSelect'),
            watchLaterBtn: document.getElementById('watchLaterBtn'),
            favoriteBtn: document.getElementById('favoriteBtn'),
            queueAddBtn: document.getElementById('queueAddBtn'),
            miniBtn: document.getElementById('miniBtn'),
            castBtn: document.getElementById('castBtn'),
            focusBtn: document.getElementById('focusBtn'),
            miniPlayer: document.getElementById('miniPlayer'),
            miniBar: document.getElementById('miniBar'),
            miniTitle: document.getElementById('miniTitle'),
            miniPlayPause: document.getElementById('miniPlayPause'),
            miniClose: document.getElementById('miniClose'),
            miniFrame: document.getElementById('miniPlayerFrame')
        };

        const helpers = {
            async request(endpoint, params = {}) {
                if (appState.abortController) {
                    appState.abortController.abort();
                }
                appState.abortController = new AbortController();
                const url = new URL(`${API_BASE}/${endpoint}`);
                url.search = new URLSearchParams({ key: API_KEY, ...params }).toString();
                try {
                    const res = await fetch(url, { signal: appState.abortController.signal });
                    if (!res.ok) throw new Error(`API ${res.status}`);
                    return await res.json();
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        throw err;
                    }
                }
            },
            formatNumber(num) {
                if (!num) return '0';
                const n = Number(num);
                if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + 'M';
                if (n >= 1_000) return (n / 1_000).toFixed(1) + 'K';
                return n.toLocaleString('tr-TR');
            },
            timeAgo(dateString) {
                const diff = (Date.now() - new Date(dateString)) / 1000;
                if (diff < 60) return 'az önce';
                if (diff < 3600) return `${Math.floor(diff/60)} dk önce`;
                if (diff < 86400) return `${Math.floor(diff/3600)} saat önce`;
                if (diff < 604800) return `${Math.floor(diff/86400)} gün önce`;
                if (diff < 2629746) return `${Math.floor(diff/604800)} hafta önce`;
                if (diff < 31556952) return `${Math.floor(diff/2629746)} ay önce`;
                return `${Math.floor(diff/31556952)} yıl önce`;
            },
            duration(pt) {
                if (!pt) return '00:00';
                const regex = /PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/;
                const [,h,m,s] = pt.match(regex) || [];
                const hours = h ? `${h}:` : '';
                const minutes = m ? String(m).padStart(hours ? 2 : 1, '0') : (hours ? '00' : '0');
                const seconds = s ? String(s).padStart(2,'0') : '00';
                return hours + minutes + ':' + seconds;
            },
            toast(message, type='') {
                elements.toast.textContent = message;
                elements.toast.dataset.type = type;
                elements.toast.classList.add('show');
                clearTimeout(elements.toast._timer);
                elements.toast._timer = setTimeout(() => elements.toast.classList.remove('show'), 3200);
            },
            save(key, value) {
                localStorage.setItem(key, JSON.stringify(value));
            },
            async beep() {
                try {
                    if (!audioContext) audioContext = new AudioContext();
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(880, audioContext.currentTime);
                    gain.gain.value = 0.001;
                    osc.connect(gain).connect(audioContext.destination);
                    osc.start();
                    setTimeout(() => { osc.stop(); osc.disconnect(); }, 140);
                } catch (e) { console.warn('AudioContext blocked', e); }
            }
        };

        const db = {
            async init() {
                if (dbPromise) return dbPromise;
                dbPromise = new Promise((resolve, reject) => {
                    const req = indexedDB.open('yt-premium-db', 2);
                    req.onupgradeneeded = (event) => {
                        const database = event.target.result;
                        if (!database.objectStoreNames.contains('videos')) {
                            database.createObjectStore('videos', { keyPath: 'id' });
                        }
                        if (!database.objectStoreNames.contains('settings')) {
                            database.createObjectStore('settings', { keyPath: 'key' });
                        }
                    };
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
                return dbPromise;
            },
            async saveVideos(videos) {
                const database = await db.init();
                const tx = database.transaction('videos', 'readwrite');
                const store = tx.objectStore('videos');
                videos.forEach(video => store.put(video));
            },
            async getVideo(id) {
                const database = await db.init();
                return new Promise((resolve) => {
                    const tx = database.transaction('videos', 'readonly');
                    tx.objectStore('videos').get(id).onsuccess = (e) => resolve(e.target.result);
                });
            }
        };

        const playlistManager = {
            init() {
                playlistManager.render();
                playlistManager.refreshSelect();
            },
            render() {
                const entries = Object.entries(appState.playlists);
                elements.playlistList.innerHTML = entries.length ? '' : '<span style="color:var(--text-secondary);">Henüz playlist yok.</span>';
                for (const [name, list] of entries) {
                    const div = document.createElement('div');
                    div.style.display = 'flex';
                    div.style.justifyContent = 'space-between';
                    div.style.alignItems = 'center';
                    div.innerHTML = `<span>${name} <span class="badge">${list.length}</span></span>`;
                    const btn = document.createElement('button');
                    btn.className = 'chip';
                    btn.textContent = 'İzle';
                    btn.onclick = () => {
                        elements.searchSection.hidden = false;
                        elements.trendingSection.hidden = true;
                        renderVideoGrid(list, elements.searchGrid, true);
                        elements.searchTitle.textContent = `🎵 ${name} playlisti`;
                    };
                    div.appendChild(btn);
                    elements.playlistList.appendChild(div);
                }
            },
            refreshSelect() {
                elements.playlistSelect.innerHTML = '<option value="">Seç</option>';
                Object.keys(appState.playlists).forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    elements.playlistSelect.appendChild(opt);
                });
            },
            create(name) {
                if (!name) return helpers.toast('Playlist adı gerekli', 'warn');
                if (appState.playlists[name]) return helpers.toast('Playlist zaten var');
                appState.playlists[name] = [];
                helpers.save('yt-playlists', appState.playlists);
                playlistManager.init();
                helpers.toast('Playlist oluşturuldu', 'success');
            },
            addCurrent(name) {
                if (!name || !appState.currentVideo) return;
                const list = appState.playlists[name] || [];
                if (list.find(item => (item.id || item.data?.id) === appState.currentVideo.id)) {
                    helpers.toast('Bu video zaten playlistte');
                    return;
                }
                list.push(appState.currentVideo.meta);
                appState.playlists[name] = list;
                helpers.save('yt-playlists', appState.playlists);
                playlistManager.init();
                helpers.toast('Playlist güncellendi', 'success');
            }
        };

        function setTheme(theme) {
            document.documentElement.dataset.theme = theme;
            appState.theme = theme;
            localStorage.setItem('yt-theme', theme);
        }

        function toggleTheme() {
            setTheme(appState.theme === 'dark' ? 'light' : 'dark');
        }

        function toggleFocus() {
            document.body.classList.toggle('focus-mode');
            helpers.toast(document.body.classList.contains('focus-mode') ? 'Focus modu açık' : 'Focus modu kapalı');
        }

        async function ensureServiceWorker() {
            if (!('serviceWorker' in navigator)) return;
            const swCode = `
                const CACHE = 'yt-premium-cache-v1';
                const API_CACHE = 'yt-premium-api';
                self.addEventListener('install', evt => {
                    evt.waitUntil(caches.open(CACHE).then(cache => cache.addAll(['/', self.location.pathname])));
                });
                self.addEventListener('activate', evt => {
                    evt.waitUntil(self.clients.claim());
                });
                self.addEventListener('fetch', evt => {
                    const url = new URL(evt.request.url);
                    if (url.origin.includes('googleapis')) {
                        evt.respondWith(caches.open(API_CACHE).then(cache => fetch(evt.request).then(res => { cache.put(evt.request, res.clone()); return res; }).catch(() => cache.match(evt.request))));
                        return;
                    }
                    evt.respondWith(caches.match(evt.request).then(res => res || fetch(evt.request)));
                });
            `;
            const blob = new Blob([swCode], { type: 'text/javascript' });
            const swUrl = URL.createObjectURL(blob);
            try {
                await navigator.serviceWorker.register(swUrl);
            } catch (err) {
                console.warn('SW kayıt hatası', err);
            }
        }

        function setupManifest() {
            const manifest = {
                name: 'YouTube Premium+',
                short_name: 'YT+',
                description: 'Premium YouTube deneyimi',
                start_url: '.',
                display: 'standalone',
                background_color: '#111111',
                theme_color: '#ff0000',
                icons: [
                    {
                        src: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="22" fill="%23ff0000"/><polygon points="40,30 40,70 70,50" fill="white"/></svg>',
                        sizes: '192x192',
                        type: 'image/svg+xml'
                    }
                ]
            };
            const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = url;
            document.head.appendChild(link);
        }

        function renderCategories() {
            elements.categoryRow.innerHTML = '';
            CATEGORIES.forEach(cat => {
                const button = document.createElement('button');
                button.className = 'chip' + (cat.id === appState.activeCategory ? ' active' : '');
                button.textContent = cat.title;
                button.dataset.id = cat.id;
                button.onclick = () => {
                    CATEGORIES.forEach(c => document.querySelector(`[data-id="${c.id}"]`)?.classList.remove('active'));
                    button.classList.add('active');
                    appState.activeCategory = cat.id;
                    if (cat.id === 'podcast') {
                        loadPodcasts();
                    } else if (appState.searchQuery) {
                        searchVideos(appState.searchQuery, true);
                    } else {
                        loadTrending();
                    }
                };
                elements.categoryRow.appendChild(button);
            });
        }

        async function loadTrending() {
            appState.searchQuery = '';
            elements.searchSection.hidden = true;
            elements.trendingSection.hidden = false;
            await fetchVideos({
                endpoint: 'videos',
                params: {
                    part: 'snippet,contentDetails,statistics',
                    chart: 'mostPopular',
                    maxResults: 24,
                    regionCode: 'TR',
                    videoCategoryId: appState.activeCategory || undefined
                },
                target: elements.trendingGrid,
                cacheKey: 'trending'
            });
        }

        async function loadPodcasts() {
            elements.trendingSection.hidden = false;
            elements.searchSection.hidden = true;
            await fetchVideos({
                endpoint: 'search',
                params: {
                    part: 'snippet',
                    q: 'podcast ' + (appState.activeCategory && appState.activeCategory !== 'podcast' ? appState.activeCategory : ''),
                    type: 'video',
                    maxResults: 24,
                    order: 'date'
                },
                target: elements.trendingGrid,
                transform: (items) => items.map(item => ({
                    id: item.id.videoId,
                    snippet: item.snippet,
                    contentDetails: { duration: null },
                    statistics: {}
                }))
            });
        }

        async function searchVideos(query, reset=false) {
            if (!query) return;
            if (reset) appState.nextPageToken = null;
            elements.searchSection.hidden = false;
            elements.trendingSection.hidden = true;
            elements.searchTitle.textContent = `🔍 "${query}" için sonuçlar`;
            await fetchVideos({
                endpoint: 'search',
                params: {
                    part: 'snippet',
                    q: query,
                    type: 'video',
                    maxResults: 24,
                    videoCategoryId: appState.activeCategory || undefined,
                    pageToken: appState.nextPageToken || undefined
                },
                target: elements.searchGrid,
                append: !reset,
                transform: (items) => items.map(item => ({
                    id: item.id.videoId,
                    snippet: item.snippet
                })),
                onResponse: (data) => {
                    appState.nextPageToken = data.nextPageToken || null;
                }
            });
            storeSearch(query);
        }

        async function fetchVideos({ endpoint, params, target, append=false, transform=null, cacheKey=null, onResponse=null }) {
            try {
                showLoader();
                const data = await helpers.request(endpoint, params) || {};
                const items = transform ? transform(data.items || []) : (data.items || []);
                await db.saveVideos(items.map(item => ({ id: item.id, data: item })));
                const filtered = filterAds(items);
                if (!append) target.innerHTML = '';
                const cards = filtered.map(buildVideoCard);
                cards.forEach(card => target.appendChild(card));
                if (onResponse) onResponse(data);
                hideLoader();
                if (cacheKey && filtered.length) {
                    const signature = filtered.map(v => v.id).join(',');
                    if (signature !== appState.trendingSignature && endpoint === 'videos') {
                        notifyNewVideos(filtered[0]);
                        appState.trendingSignature = signature;
                        localStorage.setItem('yt-trending-signature', signature);
                    }
                }
                renderCollections();
                cacheThumbnails(filtered);
            } catch (err) {
                console.error(err);
                showError('Veriler alınamadı: ' + err.message);
            }
        }

        function buildVideoCard(video) {
            const id = video.id?.videoId || video.id;
            const snippet = video.snippet || {};
            const stats = video.statistics || {};
            const duration = helpers.duration(video.contentDetails?.duration);
            const card = document.createElement('article');
            card.className = 'video-card';
            card.innerHTML = `
                <div class="thumb">
                    <img data-src="${snippet.thumbnails?.medium?.url || ''}" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==" alt="${snippet.title || 'video'}" loading="lazy">
                    <div class="preview"></div>
                    <span class="duration">${duration}</span>
                </div>
                <div class="video-body">
                    <div class="video-title">${snippet.title || ''}</div>
                    <div class="video-meta">
                        <span>${snippet.channelTitle || ''}</span>
                        <div class="meta-row">
                            <span>${helpers.formatNumber(stats.viewCount)} görüntüleme</span>
                            <span>•</span>
                            <span>${helpers.timeAgo(snippet.publishedAt)}</span>
                        </div>
                    </div>
                    <div class="card-actions">
                        <span class="tag">${snippet.liveBroadcastContent === 'live' ? 'CANLI' : 'Video'}</span>
                        <div style="display:flex; gap:6px;">
                            <button class="icon-btn" data-action="favorite">❤️</button>
                            <button class="icon-btn" data-action="queue">➕</button>
                            <button class="icon-btn" data-action="watch">🕒</button>
                        </div>
                    </div>
                </div>
            `;
            const preview = card.querySelector('.preview');
            let previewTimer;
            card.addEventListener('mouseenter', () => {
                previewTimer = setTimeout(() => {
                    preview.innerHTML = `<iframe src="https://www.youtube.com/embed/${id}?autoplay=1&mute=1&controls=0&loop=1&playlist=${id}" allow="autoplay" frameborder="0" style="width:100%;height:100%;"></iframe>`;
                }, 600);
            });
            card.addEventListener('mouseleave', () => {
                clearTimeout(previewTimer);
                preview.innerHTML = '';
            });
            card.addEventListener('click', () => openVideo(id, video));
            card.querySelectorAll('.icon-btn').forEach(btn => btn.addEventListener('click', (ev) => {
                ev.stopPropagation();
                const action = btn.dataset.action;
                if (action === 'favorite') toggleFavorite(id, video);
                if (action === 'queue') addToQueue(id, video);
                if (action === 'watch') toggleWatchLater(id, video);
            }));
            return card;
        }

        function filterAds(videos) {
            if (!appState.adBlockEnabled) return videos;
            const banned = ['advert', 'sponsored', 'reklam', 'shorts'];
            return videos.filter(item => {
                const title = (item.snippet?.title || '').toLowerCase();
                return !banned.some(word => title.includes(word));
            });
        }

        function renderCollections() {
            renderVideoGrid(appState.favorites, elements.favoritesGrid, true);
            renderVideoGrid(appState.watchLater, elements.watchLaterGrid, true);
            renderVideoGrid(appState.history.slice(0, 12), elements.historyGrid, true);
        }

        function renderVideoGrid(list, container, skipActions=false) {
            container.innerHTML = list.length ? '' : '<span style="color:var(--text-secondary);">Liste boş.</span>';
            list.forEach(item => {
                const card = buildVideoCard(item.data || item);
                if (skipActions) {
                    card.querySelectorAll('.icon-btn').forEach(btn => btn.remove());
                }
                container.appendChild(card);
            });
        }

        async function cacheThumbnails(videos) {
            if (!appState.offlineEnabled || !('caches' in window)) return;
            try {
                const cache = await caches.open('yt-thumb-cache');
                videos.forEach(video => {
                    const url = video.snippet?.thumbnails?.medium?.url;
                    if (url) cache.add(url).catch(() => {});
                });
            } catch (error) {
                console.warn('Thumbnail cache failed', error);
            }
        }

        function toggleFavorite(id, video) {
            const index = appState.favorites.findIndex(v => (v.id||v.data?.id) === id);
            if (index > -1) {
                appState.favorites.splice(index,1);
                helpers.toast('Favoriden çıkarıldı');
            } else {
                appState.favorites.unshift({ id, data: video });
                helpers.toast('Favorilere eklendi', 'success');
            }
            helpers.save('yt-favorites', appState.favorites);
            renderCollections();
        }

        function toggleWatchLater(id, video) {
            const index = appState.watchLater.findIndex(v => (v.id||v.data?.id) === id);
            if (index > -1) {
                appState.watchLater.splice(index, 1);
                helpers.toast('Daha sonra listeden çıkarıldı');
            } else {
                appState.watchLater.unshift({ id, data: video });
                helpers.toast('Daha sonra listesine eklendi', 'success');
            }
            helpers.save('yt-watchlater', appState.watchLater);
            renderCollections();
        }

        function addToQueue(id, video) {
            if (appState.queue.find(item => item.id === id)) {
                helpers.toast('Video zaten kuyruğa eklenmiş');
                return;
            }
            appState.queue.push({ id, data: video });
            helpers.save('yt-queue', appState.queue);
            updateQueue();
            helpers.toast('Kuyruğa eklendi', 'success');
        }

        function updateQueue() {
            elements.queueList.innerHTML = appState.queue.length ? '' : '<span style="color:var(--text-secondary);">Kuyruk boş.</span>';
            appState.queue.forEach(item => {
                const snippet = item.data.snippet || {};
                const div = document.createElement('div');
                div.className = 'queue-item' + (appState.currentVideo?.id === item.id ? ' active' : '');
                div.innerHTML = `
                    <img src="${snippet.thumbnails?.default?.url || ''}" alt="${snippet.title}" style="width:90px;height:60px;border-radius:12px;object-fit:cover;">
                    <div>
                        <strong>${snippet.title}</strong>
                        <div style="color:var(--text-secondary); font-size:12px;">${snippet.channelTitle}</div>
                    </div>
                    <button class="icon-btn">✖</button>
                `;
                div.addEventListener('click', () => openVideo(item.id, item.data));
                div.querySelector('.icon-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeFromQueue(item.id);
                });
                elements.queueList.appendChild(div);
            });
        }

        function removeFromQueue(id) {
            appState.queue = appState.queue.filter(item => item.id !== id);
            helpers.save('yt-queue', appState.queue);
            updateQueue();
        }

        function clearQueue() {
            appState.queue = [];
            helpers.save('yt-queue', appState.queue);
            updateQueue();
        }

        async function openVideo(id, video) {
            appState.currentVideo = { id, meta: { id, data: video }, data: video };
            const snippet = video.snippet || (await db.getVideo(id))?.data?.snippet || {};
            elements.modalTitle.textContent = snippet.title || 'Video';
            elements.videoDescription.innerHTML = (snippet.description || '').replace(/\n/g, '<br>');
            elements.videoStats.innerHTML = '';
            elements.channelInfo.innerHTML = '';
            elements.videoModal.classList.add('open');
            document.body.style.overflow = 'hidden';
            await loadVideoDetails(id, snippet.channelId);
            setupPlayer(id);
            addToHistory(id, snippet, video.statistics);
            updateModalButtons(id, video);
        }

        async function loadVideoDetails(id, channelId) {
            try {
                const details = await helpers.request('videos', {
                    part: 'snippet,statistics,contentDetails',
                    id
                });
                const video = details?.items?.[0];
                if (video) {
                    elements.videoStats.innerHTML = `
                        <div style="display:flex; flex-wrap:wrap; gap:12px;">
                            <span>👁️ ${helpers.formatNumber(video.statistics.viewCount)} görüntüleme</span>
                            <span>👍 ${helpers.formatNumber(video.statistics.likeCount)} beğeni</span>
                            <span>📅 ${helpers.timeAgo(video.snippet.publishedAt)}</span>
                            <span>⏱ ${helpers.duration(video.contentDetails.duration)}</span>
                        </div>
                    `;
                    appState.currentVideo.meta = { id, data: video };
                }
                if (channelId) {
                    const channelData = await helpers.request('channels', {
                        part: 'snippet,statistics',
                        id: channelId
                    });
                    const channel = channelData?.items?.[0];
                    if (channel) {
                        elements.channelInfo.innerHTML = `
                            <img src="${channel.snippet.thumbnails.default.url}" alt="${channel.snippet.title}">
                            <div>
                                <strong>${channel.snippet.title}</strong>
                                <div style="color:var(--text-secondary); font-size:14px;">
                                    ${helpers.formatNumber(channel.statistics.subscriberCount)} abone · ${helpers.formatNumber(channel.statistics.videoCount)} video
                                </div>
                            </div>
                            <button class="chip" onclick="window.open('https://www.youtube.com/channel/${channel.id}', '_blank')">Kanalı Gör</button>
                        `;
                    }
                }
            } catch (error) {
                console.warn('Detay yüklenemedi', error);
            }
        }

        function updateModalButtons(id, video) {
            elements.watchLaterBtn.textContent = appState.watchLater.find(item => (item.id||item.data?.id) === id) ? '✅ Daha Sonra' : '🕒 Daha Sonra';
            elements.favoriteBtn.textContent = appState.favorites.find(item => (item.id||item.data?.id) === id) ? '✅ Favori' : '❤️ Favori';
            elements.queueAddBtn.textContent = appState.queue.find(item => item.id === id) ? '✅ Kuyrukta' : '➕ Kuyruğa Ekle';
            elements.loopBtn.textContent = `🔁 Loop: ${appState.loopMode === 'off' ? 'Kapalı' : appState.loopMode === 'one' ? 'Tek' : 'Tümü'}`;
            elements.speedControl.value = String(appState.playbackSpeed);
            elements.qualityControl.value = appState.quality;
        }

        function addToHistory(id, snippet, statistics) {
            appState.history = appState.history.filter(item => item.id !== id);
            appState.history.unshift({ id, data: { id, snippet, statistics } });
            appState.history = appState.history.slice(0, 120);
            helpers.save('yt-history', appState.history);
            renderCollections();
        }

        function setupPlayer(id) {
            if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') {
                setTimeout(() => setupPlayer(id), 300);
                return;
            }
            if (!ytModalPlayer) {
                ytModalPlayer = new YT.Player('modalPlayer', {
                    videoId: id,
                    playerVars: {
                        autoplay: 1,
                        rel: 0,
                        modestbranding: 1
                    },
                    events: {
                        onReady: onPlayerReady,
                        onStateChange: onPlayerStateChange
                    }
                });
            } else {
                ytModalPlayer.loadVideoById(id);
            }
        }

        function onYouTubeIframeAPIReady() {
            window.appReady = true;
            if (appState.currentVideo) {
                setupPlayer(appState.currentVideo.id);
            }
            ytMiniPlayer = new YT.Player('miniPlayerFrame', {
                videoId: '',
                playerVars: { controls: 1, rel: 0 },
                events: {
                    onStateChange: (ev) => {
                        if (ev.data === YT.PlayerState.ENDED && appState.loopMode === 'one') {
                            ytMiniPlayer.seekTo(0);
                            ytMiniPlayer.playVideo();
                        }
                    }
                }
            });
        }
        window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

        function onPlayerReady(event) {
            ytModalPlayer.setPlaybackRate(appState.playbackSpeed);
            if (appState.quality !== 'auto') {
                ytModalPlayer.setPlaybackQuality(appState.quality);
            }
            setupMediaSession();
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                if (appState.loopMode === 'one') {
                    ytModalPlayer.seekTo(0);
                    ytModalPlayer.playVideo();
                    return;
                }
                if (appState.autoPlay) {
                    playNextInQueue();
                }
            }
        }

        function playNextInQueue() {
            if (!appState.queue.length) return;
            const currentIndex = appState.queue.findIndex(item => item.id === appState.currentVideo?.id);
            let nextItem;
            if (appState.loopMode === 'all') {
                nextItem = appState.queue[(currentIndex + 1) % appState.queue.length];
            } else {
                nextItem = appState.queue[currentIndex + 1];
            }
            if (nextItem) {
                openVideo(nextItem.id, nextItem.data);
            }
        }

        function setupMediaSession() {
            if ('mediaSession' in navigator && appState.currentVideo) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: appState.currentVideo.meta?.data?.snippet?.title || 'Video',
                    artist: appState.currentVideo.meta?.data?.snippet?.channelTitle || 'YouTube',
                    artwork: [{ src: appState.currentVideo.meta?.data?.snippet?.thumbnails?.medium?.url || '', sizes: '320x180', type: 'image/jpeg' }]
                });
                navigator.mediaSession.setActionHandler('play', () => ytModalPlayer?.playVideo());
                navigator.mediaSession.setActionHandler('pause', () => ytModalPlayer?.pauseVideo());
                navigator.mediaSession.setActionHandler('previoustrack', () => {
                    const index = appState.queue.findIndex(item => item.id === appState.currentVideo?.id);
                    if (index > 0) openVideo(appState.queue[index - 1].id, appState.queue[index - 1].data);
                });
                navigator.mediaSession.setActionHandler('nexttrack', playNextInQueue);
            }
        }

        function toggleMiniPlayer() {
            if (!ytMiniPlayer || !appState.currentVideo) return;
            elements.miniPlayer.classList.toggle('open');
            if (elements.miniPlayer.classList.contains('open')) {
                ytMiniPlayer.loadVideoById(appState.currentVideo.id);
                ytMiniPlayer.playVideo();
                elements.miniTitle.textContent = appState.currentVideo.meta?.data?.snippet?.title || 'Mini Player';
                ytModalPlayer?.pauseVideo();
                elements.videoModal.classList.remove('open');
                document.body.style.overflow = '';
            } else {
                ytMiniPlayer.stopVideo();
            }
        }

        function closeModal() {
            elements.videoModal.classList.remove('open');
            document.body.style.overflow = '';
            ytModalPlayer?.stopVideo();
            clearSleepTimer();
        }

        function setupMiniDrag() {
            let dragging = false;
            let startX, startY, startLeft, startTop;
            elements.miniBar.addEventListener('mousedown', (e) => {
                dragging = true;
                startX = e.clientX;
                startY = e.clientY;
                const rect = elements.miniPlayer.getBoundingClientRect();
                startLeft = rect.left;
                startTop = rect.top;
                document.addEventListener('mousemove', onDrag);
                document.addEventListener('mouseup', stopDrag);
            });
            function onDrag(e) {
                if (!dragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                elements.miniPlayer.style.left = Math.min(window.innerWidth - elements.miniPlayer.offsetWidth, Math.max(0, startLeft + dx)) + 'px';
                elements.miniPlayer.style.top = Math.min(window.innerHeight - elements.miniPlayer.offsetHeight, Math.max(0, startTop + dy)) + 'px';
                elements.miniPlayer.style.right = 'auto';
                elements.miniPlayer.style.bottom = 'auto';
            }
            function stopDrag() {
                dragging = false;
                document.removeEventListener('mousemove', onDrag);
                document.removeEventListener('mouseup', stopDrag);
            }
        }

        function storeSearch(query) {
            appState.searchHistory = appState.searchHistory.filter(item => item !== query);
            appState.searchHistory.unshift(query);
            appState.searchHistory = appState.searchHistory.slice(0, 10);
            helpers.save('yt-search-history', appState.searchHistory);
            renderSearchHistory();
        }

        function renderSearchHistory() {
            const list = appState.searchHistory;
            if (!list.length) {
                elements.searchHistory.hidden = true;
                return;
            }
            elements.searchHistory.innerHTML = list.map(item => `<button class="chip" data-term="${item}">${item}</button>`).join('');
        }

        function setupSearchHistory() {
            renderSearchHistory();
            elements.searchInput.addEventListener('focus', () => {
                if (appState.searchHistory.length) {
                    renderSearchHistory();
                    elements.searchHistory.hidden = false;
                }
            });
            elements.searchInput.addEventListener('blur', () => {
                setTimeout(() => elements.searchHistory.hidden = true, 200);
            });
            elements.searchHistory.addEventListener('click', (e) => {
                if (e.target.dataset.term) {
                    elements.searchInput.value = e.target.dataset.term;
                    performSearch();
                }
            });
        }

        function setupSentinel() {
            if (appState.sentinelObserver) appState.sentinelObserver.disconnect();
            appState.sentinelObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && appState.nextPageToken && appState.searchQuery) {
                        searchVideos(appState.searchQuery, false);
                    }
                });
            }, { rootMargin: '600px' });
            appState.sentinelObserver.observe(elements.sentinel);
        }

        function showLoader() {
            appState.isLoading = true;
            elements.loader.hidden = false;
            elements.error.hidden = true;
        }

        function hideLoader() {
            appState.isLoading = false;
            elements.loader.hidden = true;
        }

        function showError(message) {
            elements.error.hidden = false;
            elements.errorMessage.textContent = message;
        }

        function notifyNewVideos(video) {
            if (!('Notification' in window)) return;
            if (Notification.permission === 'granted') {
                new Notification('Yeni trend video', {
                    body: video?.snippet?.title || 'Yeni video',
                    icon: video?.snippet?.thumbnails?.default?.url
                });
                helpers.beep();
            }
        }

        async function downloadVideo(id) {
            try {
                const infoUrl = `https://cors.isomorphic-git.org/https://www.youtube.com/get_video_info?video_id=${id}&el=detailpage`;
                const res = await fetch(infoUrl);
                if (!res.ok) throw new Error('Video bilgisi alınamadı');
                const text = await res.text();
                const urlParams = new URLSearchParams(text);
                const playerResponse = JSON.parse(urlParams.get('player_response') || '{}');
                const formats = playerResponse.streamingData?.formats || playerResponse.streamingData?.adaptiveFormats || [];
                const mp4 = formats.find(f => f.mimeType?.includes('video/mp4'));
                if (mp4?.url) {
                    const a = document.createElement('a');
                    a.href = mp4.url;
                    a.download = `${appState.currentVideo?.meta?.data?.snippet?.title || id}.mp4`;
                    a.click();
                    helpers.toast('İndirme başlatıldı', 'success');
                } else {
                    window.open(`https://www.y2mate.com/youtube/${id}`, '_blank');
                    helpers.toast('Harici indirme sayfası açıldı', 'warn');
                }
            } catch (error) {
                console.warn(error);
                window.open(`https://www.y2mate.com/youtube/${id}`, '_blank');
                helpers.toast('Harici indirme sayfası açıldı', 'warn');
            }
        }

        function toggleLoopMode() {
            appState.loopMode = appState.loopMode === 'off' ? 'one' : appState.loopMode === 'one' ? 'all' : 'off';
            localStorage.setItem('yt-loop', appState.loopMode);
            updateModalButtons(appState.currentVideo?.id, appState.currentVideo?.data);
            helpers.toast(`Loop modu: ${appState.loopMode}`);
        }

        function setPlaybackSpeed(speed) {
            appState.playbackSpeed = parseFloat(speed);
            localStorage.setItem('yt-speed', speed);
            ytModalPlayer?.setPlaybackRate(appState.playbackSpeed);
            ytMiniPlayer?.setPlaybackRate(appState.playbackSpeed);
        }

        function setQuality(quality) {
            appState.quality = quality;
            localStorage.setItem('yt-quality', quality);
            if (quality !== 'auto') {
                ytModalPlayer?.setPlaybackQuality(quality);
                ytMiniPlayer?.setPlaybackQuality(quality);
            }
        }

        function setSleepTimer(minutes) {
            clearSleepTimer();
            if (minutes > 0) {
                appState.sleepTimeout = setTimeout(() => {
                    ytModalPlayer?.pauseVideo();
                    ytMiniPlayer?.pauseVideo();
                    helpers.toast('Uyku zamanlayıcı: video durduruldu');
                }, minutes * 60 * 1000);
            }
        }

        function clearSleepTimer() {
            if (appState.sleepTimeout) {
                clearTimeout(appState.sleepTimeout);
                appState.sleepTimeout = null;
            }
        }

        function toggleAutoPlay(enabled) {
            appState.autoPlay = enabled;
            localStorage.setItem('yt-autoplay', enabled);
        }

        function toggleAdBlock(enabled) {
            appState.adBlockEnabled = enabled;
            localStorage.setItem('yt-adblock', enabled);
        }

        function toggleBandwidthSaver(enabled) {
            appState.bandwidthSaver = enabled;
            localStorage.setItem('yt-bandwidth', enabled);
            setQuality(enabled ? 'medium' : appState.quality);
        }

        function toggleOffline(enabled) {
            appState.offlineEnabled = enabled;
            localStorage.setItem('yt-offline', enabled);
            if (!enabled && 'caches' in window) {
                caches.delete('yt-thumb-cache');
            }
            helpers.toast(enabled ? 'Çevrimdışı önbellek açık' : 'Çevrimdışı önbellek kapalı');
        }

        function exportSettings() {
            const data = {
                queue: appState.queue,
                favorites: appState.favorites,
                watchLater: appState.watchLater,
                history: appState.history,
                playlists: appState.playlists,
                theme: appState.theme,
                settings: {
                    loopMode: appState.loopMode,
                    autoPlay: appState.autoPlay,
                    adBlock: appState.adBlockEnabled,
                    bandwidthSaver: appState.bandwidthSaver,
                    offlineEnabled: appState.offlineEnabled,
                    speed: appState.playbackSpeed,
                    quality: appState.quality
                }
            };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'yt-premium-settings.json';
            a.click();
            URL.revokeObjectURL(url);
            helpers.toast('Ayarlar dışa aktarıldı', 'success');
        }

        function importSettings(file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    appState.queue = data.queue || [];
                    appState.favorites = data.favorites || [];
                    appState.watchLater = data.watchLater || [];
                    appState.history = data.history || [];
                    appState.playlists = data.playlists || {};
                    Object.assign(appState, data.settings || {});
                    localStorage.setItem('yt-queue', JSON.stringify(appState.queue));
                    localStorage.setItem('yt-favorites', JSON.stringify(appState.favorites));
                    localStorage.setItem('yt-watchlater', JSON.stringify(appState.watchLater));
                    localStorage.setItem('yt-history', JSON.stringify(appState.history));
                    localStorage.setItem('yt-playlists', JSON.stringify(appState.playlists));
                    localStorage.setItem('yt-loop', appState.loopMode);
                    localStorage.setItem('yt-autoplay', appState.autoPlay);
                    localStorage.setItem('yt-adblock', appState.adBlockEnabled);
                    localStorage.setItem('yt-bandwidth', appState.bandwidthSaver);
                    localStorage.setItem('yt-offline', appState.offlineEnabled);
                    localStorage.setItem('yt-speed', appState.playbackSpeed);
                    localStorage.setItem('yt-quality', appState.quality);
                    playlistManager.init();
                    renderCollections();
                    updateQueue();
                    helpers.toast('Ayarlar içe aktarıldı', 'success');
                } catch (error) {
                    helpers.toast('Ayarlar yüklenemedi', 'error');
                }
            };
            reader.readAsText(file);
        }

        function clearHistoryData() {
            appState.history = [];
            helpers.save('yt-history', appState.history);
            renderCollections();
            helpers.toast('Geçmiş temizlendi');
        }

        function setupNotifications() {
            if (!('Notification' in window)) return;
            elements.notifyBtn.addEventListener('click', async () => {
                if (Notification.permission === 'granted') {
                    helpers.toast('Bildirimler zaten açık');
                } else {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') helpers.toast('Bildirimler etkin');
                }
            });
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.target.matches('input, textarea')) return;
                switch (e.code) {
                    case 'Space':
                        e.preventDefault();
                        if (typeof YT !== 'undefined' && ytModalPlayer?.getPlayerState() === YT.PlayerState.PLAYING) {
                            ytModalPlayer.pauseVideo();
                        } else {
                            ytModalPlayer?.playVideo();
                        }
                        break;
                    case 'KeyM':
                        toggleMiniPlayer();
                        break;
                    case 'KeyL':
                        toggleLoopMode();
                        break;
                    case 'KeyF':
                        toggleFocus();
                        break;
                    case 'ArrowRight':
                        if (ytModalPlayer) ytModalPlayer.seekTo(ytModalPlayer.getCurrentTime() + 5, true);
                        break;
                    case 'ArrowLeft':
                        if (ytModalPlayer) ytModalPlayer.seekTo(Math.max(ytModalPlayer.getCurrentTime() - 5, 0), true);
                        break;
                    case 'ArrowUp':
                        adjustVolume(0.1);
                        break;
                    case 'ArrowDown':
                        adjustVolume(-0.1);
                        break;
                }
            });
        }

        function adjustVolume(delta) {
            if (!ytModalPlayer) return;
            const current = ytModalPlayer.getVolume();
            const next = Math.min(100, Math.max(0, current + delta * 100));
            ytModalPlayer.setVolume(next);
            helpers.toast(`Ses: ${Math.round(next)}%`);
        }

        function setupGestures() {
            let touchStartX = 0;
            let touchStartY = 0;
            let pinchStart = null;
            document.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                } else if (e.touches.length === 2) {
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    pinchStart = Math.sqrt(dx*dx + dy*dy);
                }
            }, { passive: true });
            document.addEventListener('touchend', (e) => {
                if (e.changedTouches.length === 1) {
                    const dx = e.changedTouches[0].clientX - touchStartX;
                    const dy = e.changedTouches[0].clientY - touchStartY;
                    if (Math.abs(dx) > 120 && Math.abs(dy) < 80) {
                        if (ytModalPlayer) {
                            const current = ytModalPlayer.getCurrentTime();
                            if (dx > 0) {
                                ytModalPlayer.seekTo(current + 10, true);
                            } else {
                                ytModalPlayer.seekTo(Math.max(current - 10, 0), true);
                            }
                        }
                    }
                }
                pinchStart = null;
            });
            document.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2 && pinchStart) {
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    const current = Math.sqrt(dx*dx + dy*dy);
                    if (current - pinchStart > 40) {
                        document.body.classList.add('focus-mode');
                    } else if (pinchStart - current > 40) {
                        document.body.classList.remove('focus-mode');
                    }
                }
            }, { passive: true });
        }

        function setupIntersectionLazyLoad() {
            const io = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        if (img.dataset.src) {
                            img.src = img.dataset.src;
                            observer.unobserve(img);
                        }
                    }
                });
            }, { rootMargin: '200px' });
            const mutationObserver = new MutationObserver((mutations) => {
                mutations.forEach(mutation => {
                    mutation.addedNodes.forEach(node => {
                        if (node instanceof HTMLElement) {
                            if (node.matches?.('img[data-src]')) io.observe(node);
                            node.querySelectorAll?.('img[data-src]').forEach(img => io.observe(img));
                        }
                    });
                });
            });
            mutationObserver.observe(document.body, { childList: true, subtree: true });
        }

        function setupCast() {
            if (!window.cast || !cast.framework) return;
            if (elements.castBtn.dataset.castInit) return;
            castContext = cast.framework.CastContext.getInstance();
            castContext.setOptions({
                receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
            });
            elements.castBtn.addEventListener('click', async () => {
                if (!appState.currentVideo) return;
                try {
                    await castContext.requestSession();
                    const mediaInfo = new chrome.cast.media.MediaInfo(`https://www.youtube.com/watch?v=${appState.currentVideo.id}`, 'video/mp4');
                    const request = new chrome.cast.media.LoadRequest(mediaInfo);
                    castContext.getCurrentSession().loadMedia(request);
                } catch (error) {
                    helpers.toast('Cast başlatılamadı', 'error');
                }
            });
            elements.castBtn.dataset.castInit = 'true';
        }

        window.__onGCastApiAvailable = function(isAvailable) {
            if (isAvailable) setupCast();
        };

        function setupBackgroundAudio() {
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && elements.miniPlayer.classList.contains('open')) {
                    ytMiniPlayer?.playVideo();
                }
            });
        }

        function performSearch() {
            const query = elements.searchInput.value.trim();
            if (!query) return;
            appState.searchQuery = query;
            searchVideos(query, true);
        }

        function toggleQueue() {
            elements.queuePanel.classList.toggle('open');
        }

        function toggleSettings() {
            elements.settingsDrawer.classList.toggle('open');
        }

        function setupEventListeners() {
            elements.searchBtn.addEventListener('click', performSearch);
            elements.searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') performSearch(); });
            elements.themeToggle.addEventListener('click', toggleTheme);
            elements.focusToggle.addEventListener('click', toggleFocus);
            elements.queueToggle.addEventListener('click', toggleQueue);
            elements.queueClear.addEventListener('click', clearQueue);
            elements.settingsToggle.addEventListener('click', toggleSettings);
            elements.settingsClose.addEventListener('click', toggleSettings);
            elements.closeModal.addEventListener('click', closeModal);
            elements.retryBtn.addEventListener('click', () => {
                elements.error.hidden = true;
                if (appState.searchQuery) {
                    searchVideos(appState.searchQuery, true);
                } else if (appState.activeCategory === 'podcast') {
                    loadPodcasts();
                } else {
                    loadTrending();
                }
            });
            elements.miniBtn.addEventListener('click', toggleMiniPlayer);
            elements.miniClose.addEventListener('click', () => { elements.miniPlayer.classList.remove('open'); ytMiniPlayer?.stopVideo(); });
            elements.miniPlayPause.addEventListener('click', () => {
                const state = ytMiniPlayer?.getPlayerState();
                if (state === YT.PlayerState.PLAYING) ytMiniPlayer.pauseVideo(); else ytMiniPlayer?.playVideo();
            });
            elements.loopBtn.addEventListener('click', toggleLoopMode);
            elements.watchLaterBtn.addEventListener('click', () => appState.currentVideo && toggleWatchLater(appState.currentVideo.id, appState.currentVideo.data));
            elements.favoriteBtn.addEventListener('click', () => appState.currentVideo && toggleFavorite(appState.currentVideo.id, appState.currentVideo.data));
            elements.queueAddBtn.addEventListener('click', () => appState.currentVideo && addToQueue(appState.currentVideo.id, appState.currentVideo.data));
            elements.downloadBtn.addEventListener('click', () => appState.currentVideo && downloadVideo(appState.currentVideo.id));
            elements.speedControl.addEventListener('change', (e) => setPlaybackSpeed(e.target.value));
            elements.qualityControl.addEventListener('change', (e) => setQuality(e.target.value));
            elements.sleepTimer.addEventListener('change', (e) => setSleepTimer(parseInt(e.target.value, 10)));
            elements.playlistSelect.addEventListener('change', (e) => playlistManager.addCurrent(e.target.value));
            elements.focusBtn.addEventListener('click', toggleFocus);
            elements.autoPlayToggle.addEventListener('change', (e) => toggleAutoPlay(e.target.checked));
            elements.adBlockToggle.addEventListener('change', (e) => toggleAdBlock(e.target.checked));
            elements.bandwidthToggle.addEventListener('change', (e) => toggleBandwidthSaver(e.target.checked));
            elements.offlineToggle.addEventListener('change', (e) => toggleOffline(e.target.checked));
            elements.exportBtn.addEventListener('click', exportSettings);
            elements.importBtn.addEventListener('click', () => elements.importInput.click());
            elements.importInput.addEventListener('change', (e) => e.target.files[0] && importSettings(e.target.files[0]));
            elements.clearHistory.addEventListener('click', clearHistoryData);
            elements.createPlaylist.addEventListener('click', () => {
                playlistManager.create(elements.playlistName.value.trim());
                elements.playlistName.value = '';
            });
            elements.homeLink.addEventListener('click', (e) => { e.preventDefault(); loadTrending(); });
            window.addEventListener('resize', () => {
                if (!elements.miniPlayer.classList.contains('open')) return;
                const rect = elements.miniPlayer.getBoundingClientRect();
                if (rect.right > window.innerWidth) elements.miniPlayer.style.left = (window.innerWidth - rect.width - 16) + 'px';
                if (rect.bottom > window.innerHeight) elements.miniPlayer.style.top = (window.innerHeight - rect.height - 16) + 'px';
            });
        }

        function initTheme() {
            setTheme(appState.theme);
            elements.autoPlayToggle.checked = appState.autoPlay;
            elements.adBlockToggle.checked = appState.adBlockEnabled;
            elements.bandwidthToggle.checked = appState.bandwidthSaver;
            elements.offlineToggle.checked = appState.offlineEnabled;
        }

        function showStartupTips() {
            if (localStorage.getItem('yt-first-run')) return;
            helpers.toast('Hoş geldiniz! Trend videolar yükleniyor...', 'success');
            localStorage.setItem('yt-first-run', '1');
        }

        async function init() {
            setTheme(appState.theme);
            renderCategories();
            renderCollections();
            updateQueue();
            playlistManager.init();
            setupEventListeners();
            setupSearchHistory();
            setupSentinel();
            setupKeyboardShortcuts();
            setupGestures();
            setupIntersectionLazyLoad();
            setupNotifications();
            setupMiniDrag();
            setupCast();
            setupBackgroundAudio();
            initTheme();
            showStartupTips();
            setupManifest();
            ensureServiceWorker();
            loadTrending();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
